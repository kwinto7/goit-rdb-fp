-- 1
CREATE SCHEMA pandemic;
USE pandemic;
SELECT * FROM infectious_cases;

-- 2
CREATE TABLE entity_dim (
    entity_id   INT AUTO_INCREMENT PRIMARY KEY,
    entity_name VARCHAR(255) NOT NULL,
    code        CHAR(5) NULL,
    UNIQUE (entity_name, code)
);

INSERT INTO entity_dim (entity_name, code)
SELECT DISTINCT Entity, Code
FROM infectious_cases;

ALTER TABLE entity_dim
    MODIFY code VARCHAR(10) NULL;

CREATE TABLE infectious_cases_3nf (
    entity_id              INT NOT NULL,
    year                   INT NOT NULL,
    Number_yaws            TEXT,
    polio_cases            INT,
    cases_guinea_worm      INT,
    Number_rabies          TEXT,
    Number_malaria         TEXT,
    Number_hiv             TEXT,
    Number_tuberculosis    TEXT,
    Number_smallpox        TEXT,
    Number_cholera_cases   TEXT,
    PRIMARY KEY (entity_id, year),
    FOREIGN KEY (entity_id) REFERENCES entity_dim(entity_id)
);

INSERT INTO infectious_cases_3nf (
    entity_id, year,
    Number_yaws,
    polio_cases,
    cases_guinea_worm,
    Number_rabies,
    Number_malaria,
    Number_hiv,
    Number_tuberculosis,
    Number_smallpox,
    Number_cholera_cases
)
SELECT
    d.entity_id,
    ic.Year,
    ic.Number_yaws,
    ic.polio_cases,
    ic.cases_guinea_worm,
    ic.Number_rabies,
    ic.Number_malaria,
    ic.Number_hiv,
    ic.Number_tuberculosis,
    ic.Number_smallpox,
    ic.Number_cholera_cases
FROM infectious_cases AS ic
JOIN entity_dim AS d
  ON ic.Entity = d.entity_name
 AND ic.Code  <=> d.code;
  
 SELECT COUNT(*) FROM pandemic.infectious_cases;
 
 -- 3
SELECT
    e.entity_id,
    e.entity_name AS Entity,
    e.code        AS Code,
    AVG(i.Number_rabies) AS avg_rabies,
    MIN(i.Number_rabies) AS min_rabies,
    MAX(i.Number_rabies) AS max_rabies,
    SUM(i.Number_rabies) AS sum_rabies
FROM infectious_cases_3nf AS i
JOIN entity_dim AS e
  ON i.entity_id = e.entity_id
WHERE i.Number_rabies IS NOT NULL          
GROUP BY e.entity_id, e.entity_name, e.code
ORDER BY avg_rabies DESC
LIMIT 10;
 
 -- 4
SELECT
    ic.entity_id,
    ic.`year`,
    STR_TO_DATE(CONCAT(ic.`year`, '-01-01'), '%Y-%m-%d') AS first_day_of_year,
    CURDATE() AS today_date,
    TIMESTAMPDIFF(
        YEAR,
        STR_TO_DATE(CONCAT(ic.`year`, '-01-01'), '%Y-%m-%d'),
        CURDATE()
    ) AS diff_years
FROM infectious_cases_3nf AS ic;

-- 5
DELIMITER //

DROP FUNCTION IF EXISTS year_diff_from_year //

CREATE FUNCTION year_diff_from_year(p_year INT)
RETURNS INT
DETERMINISTIC
BEGIN
    RETURN TIMESTAMPDIFF(
               YEAR,
               STR_TO_DATE(CONCAT(p_year, '-01-01'), '%Y-%m-%d'),
               CURDATE()
           );
END //

DELIMITER ;
 
 SELECT
    ic.entity_id,
    ic.`year`,
    year_diff_from_year(ic.`year`) AS years_diff
FROM infectious_cases_3nf AS ic
LIMIT 10;
